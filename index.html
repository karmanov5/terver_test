<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –ø–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ: –î–∏—Å–ø–µ—Ä—Å–∏—è –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
        }
        .katex-display {
            margin: 0;
        }
        /* Custom styles for better visual feedback */
        .correct-answer {
            background-color: #e0fbe0;
            border-color: #34d399;
        }
        .incorrect-answer {
            background-color: #ffebee;
            border-color: #f87171;
        }
        .correct-input {
             background-color: #e0fbe0 !important;
             border-color: #34d399 !important;
        }
        .incorrect-input {
             background-color: #ffebee !important;
             border-color: #f87171 !important;
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <!-- Start Screen -->
    <div id="start-container" class="bg-white w-full max-w-2xl rounded-2xl shadow-lg p-6 sm:p-8 text-center">
        <h2 class="text-2xl sm:text-3xl font-bold text-slate-800 mb-4">–¢–µ—Å—Ç –ø–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ</h2>
        <p class="text-base sm:text-lg text-slate-600 mb-6">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.</p>
        <div class="space-y-4 mb-8">
            <input type="text" id="first-name" placeholder="–ò–º—è" class="w-full text-center text-lg border-2 border-slate-300 rounded-lg p-3 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-colors">
            <input type="text" id="last-name" placeholder="–§–∞–º–∏–ª–∏—è" class="w-full text-center text-lg border-2 border-slate-300 rounded-lg p-3 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-colors">
            <p id="name-error" class="text-red-500 text-sm hidden">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è.</p>
        </div>
        <button id="start-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-transform transform hover:scale-105">
            –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç
        </button>
    </div>

    <!-- Quiz Screen -->
    <div id="quiz-container" class="bg-white w-full max-w-2xl rounded-2xl shadow-lg p-6 md:p-8 transition-all duration-300 hidden">
        <!-- Header and Progress Bar -->
        <div id="quiz-header" class="mb-6">
            <div class="flex flex-wrap justify-between items-center gap-y-2 mb-2">
                <h1 class="text-xl sm:text-2xl font-bold text-slate-800">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –î–∏—Å–ø–µ—Ä—Å–∏—è</h1>
                 <div class="flex items-center space-x-3">
                     <p id="timer" class="text-base font-bold text-slate-600 bg-slate-100 px-3 py-1 rounded-full w-[70px] text-center tracking-wider"></p>
                     <p id="progress-text" class="text-sm font-medium text-slate-500 bg-slate-100 px-3 py-1 rounded-full">–í–æ–ø—Ä–æ—Å 1 –∏–∑ 20</p>
                 </div>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2">
                <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 5%;"></div>
            </div>
        </div>
        
        <!-- Question Area -->
        <div id="question-area" class="mb-6">
            <p id="question-text" class="text-lg text-slate-700 leading-relaxed min-h-[60px]"></p>
        </div>

        <!-- Answer Area -->
        <div id="answer-area" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
            <!-- Answer buttons/inputs will be generated here -->
        </div>
        
        <!-- Feedback Area -->
        <div id="feedback-area" class="min-h-[60px] flex flex-col justify-center">
             <div id="hint-box" class="hidden cursor-pointer bg-slate-100 p-3 rounded-lg text-slate-600 text-sm">
                <span class="font-semibold">üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞:</span> <span id="hint-text"></span>
            </div>
            <div id="result-text" class="text-center font-semibold text-lg p-2 rounded-md"></div>
        </div>

        <!-- Next Button -->
        <div class="mt-6 flex justify-end">
            <button id="next-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-transform transform hover:scale-105 hidden">
                –î–∞–ª–µ–µ
            </button>
        </div>
    </div>

    <!-- Results Screen -->
    <div id="results-container" class="hidden bg-white w-full max-w-2xl rounded-2xl shadow-lg p-6 sm:p-8 text-center">
        <h2 id="user-name-result" class="text-2xl sm:text-3xl font-bold text-slate-800 mb-4">–†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
        <div class="relative w-40 h-40 mx-auto mb-6 flex items-center justify-center">
            <svg class="w-full h-full" viewBox="0 0 36 36">
                <path class="stroke-current text-slate-200" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="4"></path>
                <path id="result-circle" class="stroke-current text-blue-600" stroke-width="4" stroke-linecap="round" stroke-dasharray="0, 100" fill="none" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
            </svg>
            <span id="score-percentage" class="absolute text-3xl sm:text-4xl font-bold text-slate-800">0%</span>
        </div>
        <div class="flex justify-around items-center mb-8 bg-slate-50 p-4 rounded-lg">
             <div>
                <p class="text-slate-500 text-sm font-medium">–ë–ê–õ–õ–´</p>
                <p id="score-text" class="text-2xl sm:text-3xl font-bold text-slate-800">0/20</p>
             </div>
             <div>
                <p class="text-slate-500 text-sm font-medium">–û–¶–ï–ù–ö–ê</p>
                <p id="grade-text" class="text-2xl sm:text-3xl font-bold text-slate-800">-</p>
             </div>
        </div>
        <p id="result-message" class="text-lg sm:text-xl font-medium text-slate-700 mb-8"></p>
        <p id="saving-status" class="text-sm text-slate-500 mb-4"></p>
        <button id="restart-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-transform transform hover:scale-105">
            –ü—Ä–æ–π—Ç–∏ –µ—â–µ —Ä–∞–∑
        </button>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
    
        const onKatexLoad = () => {
             if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                      {left: '$$', right: '$$', display: true},
                      {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
             }
        };

        // --- –í–ê–ñ–ù–û: –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à—É —Å—Å—ã–ª–∫—É –Ω–∞ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Google Apps Script ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbycfhxxJrK90vZ_0yLNsE6UViaHlEMqXo9CGHH5PgWdnkArUjGs7JXdnbgm7a_ODtMv/exec'; // –ü—Ä–∏–º–µ—Ä: 'https://script.google.com/macros/s/YOUR_ID/exec'

        let quizData = [ // Made 'let' to allow modification from localStorage
            {
                "question": "–ß—Ç–æ –∏–∑–º–µ—Ä—è–µ—Ç –¥–∏—Å–ø–µ—Ä—Å–∏—è?",
                "answerOptions": [
                    { "text": "–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö.", "isCorrect": false },
                    { "text": "–ù–∞—Å–∫–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –Ω–∞–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–∑–±—Ä–æ—Å–∞–Ω—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å—Ä–µ–¥–Ω–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è.", "isCorrect": true },
                    { "text": "–ù–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞—é—â–µ–µ—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –Ω–∞–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö.", "isCorrect": false },
                    { "text": "–†–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º.", "isCorrect": false }
                ],
                "hint": "–í—Å–ø–æ–º–Ω–∏—Ç–µ, —á—Ç–æ –¥–∏—Å–ø–µ—Ä—Å–∏—è —Å–≤—è–∑–∞–Ω–∞ —Å '—Ä–∞–∑–±—Ä–æ—Å–æ–º' –∏–ª–∏ '–≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å—é' –¥–∞–Ω–Ω—ã—Ö."
            },
            {
                "question": "–ß—Ç–æ —Ç–∞–∫–æ–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ?",
                "answerOptions": [
                    { "text": "–ö–≤–∞–¥—Ä–∞—Ç –¥–∏—Å–ø–µ—Ä—Å–∏–∏.", "isCorrect": false },
                    { "text": "–ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –∫–æ—Ä–µ–Ω—å –∏–∑ –¥–∏—Å–ø–µ—Ä—Å–∏–∏.", "isCorrect": true },
                    { "text": "–°—Ä–µ–¥–Ω–µ–µ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö.", "isCorrect": false },
                    { "text": "–°—É–º–º–∞ –≤—Å–µ—Ö –∑–Ω–∞—á–µ–Ω–∏–π, –¥–µ–ª–µ–Ω–Ω–∞—è –Ω–∞ –∏—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.", "isCorrect": false }
                ],
                "hint": "–ö–∞–∫ —Å–≤—è–∑–∞–Ω—ã –Ω–∞–∑–≤–∞–Ω–∏—è '—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ' –∏ '—Å—Ä–µ–¥–Ω–µ–∫–≤–∞–¥—Ä–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ'?"
            },
            {
                "question": "–ï—Å–ª–∏ –≤—Å–µ —á–∏—Å–ª–∞ –≤ –Ω–∞–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö –æ–¥–∏–Ω–∞–∫–æ–≤—ã, —á–µ–º—É –±—É–¥–µ—Ç —Ä–∞–≤–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ?",
                "answerOptions": [
                    { "text": "1", "isCorrect": false },
                    { "text": "0", "isCorrect": true },
                    { "text": "10", "isCorrect": false },
                    { "text": "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å.", "isCorrect": false }
                ],
                "hint": "–û—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è –ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –æ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ, –µ—Å–ª–∏ –æ–Ω–∏ –≤—Å–µ —Ä–∞–≤–Ω—ã —ç—Ç–æ–º—É —Å—Ä–µ–¥–Ω–µ–º—É?"
            },
            {
                "question": "–ö–∞–∫–æ–π –ø–µ—Ä–≤—ã–π —à–∞–≥ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–¥–µ–ª–∞—Ç—å –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –¥–∏—Å–ø–µ—Ä—Å–∏–∏?",
                "answerOptions": [
                    { "text": "–ù–∞–π—Ç–∏ –º–µ–¥–∏–∞–Ω—É –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö.", "isCorrect": false },
                    { "text": "–ù–∞–π—Ç–∏ —Å—Ä–µ–¥–Ω–µ–µ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö.", "isCorrect": true },
                    { "text": "–í–æ–∑–≤–µ—Å—Ç–∏ –∫–∞–∂–¥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∫–≤–∞–¥—Ä–∞—Ç.", "isCorrect": false },
                    { "text": "–ù–∞–π—Ç–∏ —Ä–∞–∑–º–∞—Ö –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö.", "isCorrect": false }
                ],
                "hint": "–î–∏—Å–ø–µ—Ä—Å–∏—è –∏–∑–º–µ—Ä—è–µ—Ç —Ä–∞–∑–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö *–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ* —á–µ–≥–æ?"
            },
            {
                "questionType": "FREE_RESPONSE",
                "question": "–î–∏—Å–ø–µ—Ä—Å–∏—è –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–≤–Ω–∞ 16. –ß–µ–º—É —Ä–∞–≤–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ?",
                "correctAnswers": ["4"],
                "hint": "–í—Å–ø–æ–º–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É–ª—É, —Å–≤—è–∑—ã–≤–∞—é—â—É—é —ç—Ç–∏ –¥–≤–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è.",
                "rationale": "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ ‚Äî —ç—Ç–æ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –∫–æ—Ä–µ–Ω—å –∏–∑ –¥–∏—Å–ø–µ—Ä—Å–∏–∏, –∞ $\\sqrt{16} = 4$."
            },
            {
                "question": "–ö–∞–∫–æ–π –∏–∑ –Ω–∞–±–æ—Ä–æ–≤ –¥–∞–Ω–Ω—ã—Ö –∏–º–µ–µ—Ç –±–æ–ª—å—à–∏–π —Ä–∞–∑–±—Ä–æ—Å (–±–æ–ª—å—à–µ–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ)?<br>–ù–∞–±–æ—Ä –ê: {10, 20, 30}<br>–ù–∞–±–æ—Ä –ë: {19, 20, 21}",
                "answerOptions": [
                    { "text": "–ù–∞–±–æ—Ä –ê", "isCorrect": true },
                    { "text": "–ù–∞–±–æ—Ä –ë", "isCorrect": false },
                    { "text": "–ò—Ö —Ä–∞–∑–±—Ä–æ—Å –æ–¥–∏–Ω–∞–∫–æ–≤.", "isCorrect": false },
                    { "text": "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–≤–µ—Ç–∞.", "isCorrect": false }
                ],
                "hint": "–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ, –Ω–∞—Å–∫–æ–ª—å–∫–æ –¥–∞–ª–µ–∫–æ —á–∏—Å–ª–∞ –≤ –∫–∞–∂–¥–æ–º –Ω–∞–±–æ—Ä–µ –æ—Ç—Å—Ç–æ—è—Ç –æ—Ç –∏—Ö —Ü–µ–Ω—Ç—Ä–∞."
            },
            {
                "question": "–ú–æ–∂–µ—Ç –ª–∏ –¥–∏—Å–ø–µ—Ä—Å–∏—è –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º?",
                "answerOptions": [
                    { "text": "–î–∞, –µ—Å–ª–∏ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ.", "isCorrect": false },
                    { "text": "–ù–µ—Ç, –Ω–∏–∫–æ–≥–¥–∞.", "isCorrect": true },
                    { "text": "–î–∞, –µ—Å–ª–∏ —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ä–∞–≤–Ω–æ –Ω—É–ª—é.", "isCorrect": false },
                    { "text": "–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ –Ω–∞–±–æ—Ä–µ –µ—Å—Ç—å –≤—ã–±—Ä–æ—Å—ã.", "isCorrect": false }
                ],
                "hint": "–í—Å–ø–æ–º–Ω–∏—Ç–µ, –∫–∞–∫–∞—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –¥–∏—Å–ø–µ—Ä—Å–∏–∏, –∫–æ—Ç–æ—Ä–∞—è –≤—Å–µ–≥–¥–∞ –¥–∞–µ—Ç –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç."
            },
            {
                "questionType": "FREE_RESPONSE",
                "question": "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–≤–Ω–æ 9. –ß–µ–º—É —Ä–∞–≤–Ω–∞ –¥–∏—Å–ø–µ—Ä—Å–∏—è?",
                "correctAnswers": ["81"],
                "hint": "–ï—Å–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ ‚Äî —ç—Ç–æ –∫–æ—Ä–µ–Ω—å –∏–∑ –¥–∏—Å–ø–µ—Ä—Å–∏–∏, —Ç–æ –∫–∞–∫ –Ω–∞–π—Ç–∏ –¥–∏—Å–ø–µ—Ä—Å–∏—é, –∑–Ω–∞—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ?",
                "rationale": "–î–∏—Å–ø–µ—Ä—Å–∏—è ‚Äî —ç—Ç–æ –∫–≤–∞–¥—Ä–∞—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è, –∞ $9^2 = 81$."
            },
            {
                "questionType": "FREE_RESPONSE",
                "question": "–ù–∞–π–¥–∏—Ç–µ —Å—Ä–µ–¥–Ω–µ–µ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–µ –¥–ª—è –Ω–∞–±–æ—Ä–∞ —á–∏—Å–µ–ª: {2, 5, 8, 5}",
                "correctAnswers": ["5"],
                "hint": "–°–ª–æ–∂–∏—Ç–µ –≤—Å–µ —á–∏—Å–ª–∞ –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—É—é —Å—É–º–º—É –Ω–∞ –∏—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.",
                "rationale": "–°—É–º–º–∞ —á–∏—Å–µ–ª $(2+5+8+5=20)$ –¥–µ–ª–∏—Ç—Å—è –Ω–∞ –∏—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (4), —á—Ç–æ –¥–∞–µ—Ç 5."
            },
            {
                "questionType": "FREE_RESPONSE",
                "question": "–ù–∞–π–¥–∏—Ç–µ –¥–∏—Å–ø–µ—Ä—Å–∏—é –¥–ª—è –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö: {1, 1, 5, 5}",
                "correctAnswers": ["4"],
                "hint": "–°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ —Å—Ä–µ–¥–Ω–µ–µ, –∑–∞—Ç–µ–º ‚Äî –∫–≤–∞–¥—Ä–∞—Ç—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –∫–∞–∂–¥–æ–≥–æ —á–∏—Å–ª–∞ –æ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ, –∏ –Ω–∞–∫–æ–Ω–µ—Ü ‚Äî —Å—Ä–µ–¥–Ω–µ–µ —ç—Ç–∏—Ö –∫–≤–∞–¥—Ä–∞—Ç–æ–≤.",
                "rationale": "–°—Ä–µ–¥–Ω–µ–µ —Ä–∞–≤–Ω–æ 3. –ö–≤–∞–¥—Ä–∞—Ç—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π: $(1-3)^2=4$, $(1-3)^2=4$, $(5-3)^2=4$, $(5-3)^2=4$. –°—Ä–µ–¥–Ω–µ–µ –∫–≤–∞–¥—Ä–∞—Ç–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π: $(4+4+4+4)/4 = 4$."
            },
            {
                "questionType": "FREE_RESPONSE",
                "question": "–ù–∞–π–¥–∏—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–ª—è –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö: {1, 1, 5, 5}",
                "correctAnswers": ["2"],
                "hint": "–°–Ω–∞—á–∞–ª–∞ –≤—ã—á–∏—Å–ª–∏—Ç–µ –¥–∏—Å–ø–µ—Ä—Å–∏—é, –∞ –∑–∞—Ç–µ–º –∏–∑–≤–ª–µ–∫–∏—Ç–µ –∏–∑ –Ω–µ–µ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –∫–æ—Ä–µ–Ω—å.",
                "rationale": "–î–∏—Å–ø–µ—Ä—Å–∏—è —ç—Ç–æ–≥–æ –Ω–∞–±–æ—Ä–∞ —Ä–∞–≤–Ω–∞ 4. –ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –∫–æ—Ä–µ–Ω—å –∏–∑ 4 —Ä–∞–≤–µ–Ω 2."
            },
            {
                "questionType": "FREE_RESPONSE",
                "question": "–í—ã—á–∏—Å–ª–∏—Ç–µ –¥–∏—Å–ø–µ—Ä—Å–∏—é –¥–ª—è –Ω–∞–±–æ—Ä–∞ —á–∏—Å–µ–ª: {10, 10, 10, 10}",
                "correctAnswers": ["0"],
                "hint": "–ï—Å–ª–∏ –≤ –Ω–∞–±–æ—Ä–µ –Ω–µ—Ç —Ä–∞–∑–±—Ä–æ—Å–∞, –∫–∞–∫–∏–º –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –µ–≥–æ —á–∏—Å–ª–æ–≤–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ?",
                "rationale": "–í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ä–∞–≤–Ω—ã —Å—Ä–µ–¥–Ω–µ–º—É (10), –ø–æ—ç—Ç–æ–º—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —Ä–∞–≤–Ω—ã –Ω—É–ª—é, –∏ –¥–∏—Å–ø–µ—Ä—Å–∏—è —Ç–æ–∂–µ —Ä–∞–≤–Ω–∞ –Ω—É–ª—é."
            },
            {
                "questionType": "FREE_RESPONSE",
                "question": "–ù–∞–π–¥–∏—Ç–µ –¥–∏—Å–ø–µ—Ä—Å–∏—é –¥–ª—è –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö: {1, 5}",
                "correctAnswers": ["4"],
                "hint": "–ù–∞–π–¥–∏—Ç–µ —Å—Ä–µ–¥–Ω–µ–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ä–æ–≤–Ω–æ –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ –º–µ–∂–¥—É –¥–≤—É–º—è —á–∏—Å–ª–∞–º–∏.",
                "rationale": "–°—Ä–µ–¥–Ω–µ–µ —Ä–∞–≤–Ω–æ 3. –ö–≤–∞–¥—Ä–∞—Ç—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π: $(1-3)^2=4$, $(5-3)^2=4$. –°—Ä–µ–¥–Ω–µ–µ –∫–≤–∞–¥—Ä–∞—Ç–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π: $(4+4)/2 = 4$."
            },
            {
                "questionType": "FREE_RESPONSE",
                "question": "–ù–∞–π–¥–∏—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–ª—è –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö: {1, 5}",
                "correctAnswers": ["2"],
                "hint": "–í—ã—á–∏—Å–ª–∏—Ç–µ –¥–∏—Å–ø–µ—Ä—Å–∏—é –∏ –∏–∑–≤–ª–µ–∫–∏—Ç–µ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –∫–æ—Ä–µ–Ω—å.",
                "rationale": "–î–∏—Å–ø–µ—Ä—Å–∏—è —Ä–∞–≤–Ω–∞ 4, –∞ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –∫–æ—Ä–µ–Ω—å –∏–∑ 4 —Ä–∞–≤–µ–Ω 2."
            },
            {
                "questionType": "FREE_RESPONSE",
                "question": "–ù–∞–π–¥–∏—Ç–µ –¥–∏—Å–ø–µ—Ä—Å–∏—é –¥–ª—è –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö: {7, 9, 10, 11, 13}",
                "correctAnswers": ["4"],
                "hint": "–ù–µ –∑–∞–±—É–¥—å—Ç–µ —Ä–∞–∑–¥–µ–ª–∏—Ç—å —Å—É–º–º—É –∫–≤–∞–¥—Ä–∞—Ç–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤.",
                "rationale": "–°—Ä–µ–¥–Ω–µ–µ —Ä–∞–≤–Ω–æ 10. –ö–≤–∞–¥—Ä–∞—Ç—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π: $(7-10)^2=9, (9-10)^2=1, (10-10)^2=0, (11-10)^2=1, (13-10)^2=9$. –°—Ä–µ–¥–Ω–µ–µ –∫–≤–∞–¥—Ä–∞—Ç–æ–≤: $(9+1+0+1+9)/5 = 4$."
            },
            {
                "questionType": "FREE_RESPONSE",
                "question": "–ù–∞–π–¥–∏—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–ª—è –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö: {7, 9, 10, 11, 13}",
                "correctAnswers": ["2"],
                "hint": "–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ—Ä–Ω–µ–º –∏–∑ –∑–Ω–∞—á–µ–Ω–∏—è –¥–∏—Å–ø–µ—Ä—Å–∏–∏.",
                "rationale": "–î–∏—Å–ø–µ—Ä—Å–∏—è —ç—Ç–æ–≥–æ –Ω–∞–±–æ—Ä–∞ —Ä–∞–≤–Ω–∞ 4. –ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –∫–æ—Ä–µ–Ω—å –∏–∑ 4 —Ä–∞–≤–µ–Ω 2."
            },
            {
                "question": "–î–ª—è —á–µ–≥–æ –∏–∑–º–µ—Ä—è—é—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏?",
                "answerOptions": [
                    { "text": "–ß—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Å–∞–º–æ–µ –ø–æ–ø—É–ª—è—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.", "isCorrect": false },
                    { "text": "–ß—Ç–æ–±—ã –æ—Ü–µ–Ω–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏–ª–∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö –∏–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ).", "isCorrect": true },
                    { "text": "–ß—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Å—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.", "isCorrect": false },
                    { "text": "–ß—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Å–µ—Ä–µ–¥–∏–Ω—É –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä—è–¥–∞ –¥–∞–Ω–Ω—ã—Ö.", "isCorrect": false }
                ],
                "hint": "–ü–æ–¥—É–º–∞–π—Ç–µ, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç '—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å' —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è —Ä–∞–∑–±—Ä–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö."
            },
            {
                "questionType": "FREE_RESPONSE",
                "question": "–ù–∞–π–¥–∏—Ç–µ –¥–∏—Å–ø–µ—Ä—Å–∏—é –¥–ª—è –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö: {3, 3, 7, 7}",
                "correctAnswers": ["4"],
                "hint": "–í—Å–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ –≤ —ç—Ç–æ–º –Ω–∞–±–æ—Ä–µ –ø–æ –º–æ–¥—É–ª—é –æ–¥–∏–Ω–∞–∫–æ–≤—ã.",
                "rationale": "–°—Ä–µ–¥–Ω–µ–µ —Ä–∞–≤–Ω–æ 5. –ö–≤–∞–¥—Ä–∞—Ç—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π: $(3-5)^2=4, (3-5)^2=4, (7-5)^2=4, (7-5)^2=4$. –°—Ä–µ–¥–Ω–µ–µ —ç—Ç–∏—Ö –∫–≤–∞–¥—Ä–∞—Ç–æ–≤ —Ä–∞–≤–Ω–æ $(4+4+4+4)/4 = 4$."
            },
            {
                "questionType": "FREE_RESPONSE",
                "question": "–ù–∞–π–¥–∏—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–ª—è –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö: {3, 3, 7, 7}",
                "correctAnswers": ["2"],
                "hint": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –¥–∏—Å–ø–µ—Ä—Å–∏–∏.",
                "rationale": "–î–∏—Å–ø–µ—Ä—Å–∏—è —Ä–∞–≤–Ω–∞ 4, –∞ $\\sqrt{4} = 2$."
            },
            {
                "question": "–ï—Å–ª–∏ –∫ –∫–∞–∂–¥–æ–º—É —á–∏—Å–ª—É –≤ –Ω–∞–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–±–∞–≤–∏—Ç—å 10, –∫–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ?",
                "answerOptions": [
                    { "text": "–£–≤–µ–ª–∏—á–∏—Ç—Å—è –Ω–∞ 10", "isCorrect": false },
                    { "text": "–£–≤–µ–ª–∏—á–∏—Ç—Å—è –≤ 10 —Ä–∞–∑", "isCorrect": false },
                    { "text": "–ù–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è", "isCorrect": true },
                    { "text": "–£–º–µ–Ω—å—à–∏—Ç—Å—è –Ω–∞ 10", "isCorrect": false }
                ],
                "hint": "–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ –Ω–∞–±–æ—Ä —á–∏—Å–µ–ª –Ω–∞ —á–∏—Å–ª–æ–≤–æ–π –ø—Ä—è–º–æ–π. –ï—Å–ª–∏ —Å–¥–≤–∏–Ω—É—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏ –≤–ø—Ä–∞–≤–æ –Ω–∞ 10, –∏–∑–º–µ–Ω—è—Ç—Å—è –ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –Ω–∏–º–∏?"
            }
        ];
        
        // --- DOM Elements ---
        const startContainer = document.getElementById('start-container');
        const firstNameInput = document.getElementById('first-name');
        const lastNameInput = document.getElementById('last-name');
        const nameError = document.getElementById('name-error');
        const startBtn = document.getElementById('start-btn');
        
        const quizContainer = document.getElementById('quiz-container');
        const questionTextEl = document.getElementById('question-text');
        const answerArea = document.getElementById('answer-area');
        const nextBtn = document.getElementById('next-btn');
        const progressText = document.getElementById('progress-text');
        const progressBar = document.getElementById('progress-bar');
        const resultText = document.getElementById('result-text');
        const hintBox = document.getElementById('hint-box');
        const hintTextEl = document.getElementById('hint-text');
        const timerEl = document.getElementById('timer');

        const resultsContainer = document.getElementById('results-container');
        const userNameResult = document.getElementById('user-name-result');
        const scorePercentageEl = document.getElementById('score-percentage');
        const scoreText = document.getElementById('score-text');
        const gradeText = document.getElementById('grade-text');
        const resultMessage = document.getElementById('result-message');
        const restartBtn = document.getElementById('restart-btn');
        const resultCircle = document.getElementById('result-circle');
        const savingStatus = document.getElementById('saving-status');

        // --- State ---
        let currentQuestionIndex = 0;
        let score = 0;
        let firstName = '';
        let lastName = '';
        let timerInterval;
        let timeLeft;
        const totalTime = 25 * 60; // 25 minutes in seconds
        const quizStateKey = 'statisticsQuizStateV1';


        // --- Functions ---
        
        // --- State Management Functions ---
        function saveState() {
            // Only save state if the quiz is currently active
            if (quizContainer.classList.contains('hidden')) return;
            
            const state = {
                firstName,
                lastName,
                score,
                currentQuestionIndex,
                timeLeft,
                quizData, // Save the potentially shuffled question order
            };
            localStorage.setItem(quizStateKey, JSON.stringify(state));
        }

        function clearState() {
            localStorage.removeItem(quizStateKey);
        }

        function resumeQuiz() {
            const savedStateJSON = localStorage.getItem(quizStateKey);
            if (savedStateJSON) {
                const savedState = JSON.parse(savedStateJSON);

                // Restore state variables
                firstName = savedState.firstName;
                lastName = savedState.lastName;
                score = savedState.score;
                currentQuestionIndex = savedState.currentQuestionIndex;
                timeLeft = savedState.timeLeft;
                quizData = savedState.quizData; // Restore shuffled order

                // Update UI to show quiz
                startContainer.classList.add('hidden');
                quizContainer.classList.remove('hidden');

                // Start quiz from saved state
                startTimer();
                loadQuestion();
            }
        }
        
        // --- Quiz Logic Functions ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function startQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            nextBtn.classList.add('hidden');
            loadQuestion();
        }

        function startTimer() {
            updateTimerDisplay(); // Initial display
            timerInterval = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    updateTimerDisplay();
                } else {
                    clearInterval(timerInterval);
                    showResults(true); // isTimeUp = true
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            let seconds = timeLeft % 60;
            seconds = seconds < 10 ? '0' + seconds : seconds;
            timerEl.textContent = `${minutes}:${seconds}`;
            if (timeLeft <= 30 && timeLeft > 0) { 
                 timerEl.classList.add('text-red-500', 'font-bold');
            } else {
                 timerEl.classList.remove('text-red-500', 'font-bold');
            }
        }

        function loadQuestion() {
            resultText.textContent = '';
            resultText.className = 'text-center font-semibold text-lg p-2 rounded-md';
            hintBox.classList.add('hidden');
            nextBtn.classList.add('hidden');
            
            if (currentQuestionIndex >= quizData.length) {
                showResults();
                return;
            }

            const currentQuestion = quizData[currentQuestionIndex];
            questionTextEl.innerHTML = currentQuestion.question;
            progressText.textContent = `–í–æ–ø—Ä–æ—Å ${currentQuestionIndex + 1} –∏–∑ ${quizData.length}`;
            progressBar.style.width = `${((currentQuestionIndex + 1) / quizData.length) * 100}%`;
            answerArea.innerHTML = '';

            if (currentQuestion.questionType === 'FREE_RESPONSE') {
                answerArea.classList.remove('md:grid-cols-2');
                answerArea.innerHTML = `
                    <div class="flex flex-col sm:flex-row gap-3 items-center justify-center">
                        <input type="text" id="free-response-input" class="w-full sm:w-auto flex-grow text-center text-lg border-2 border-slate-300 rounded-lg p-3 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-colors" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç">
                        <button id="submit-btn" class="w-full sm:w-auto bg-slate-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-800 transition-colors">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                    </div>
                `;
                const input = document.getElementById('free-response-input');
                const submitBtn = document.getElementById('submit-btn');
                
                input.focus();
                submitBtn.addEventListener('click', checkFreeResponseAnswer);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') checkFreeResponseAnswer();
                });

            } else {
                answerArea.classList.add('md:grid-cols-2');
                const shuffledOptions = [...currentQuestion.answerOptions];
                shuffleArray(shuffledOptions);
                shuffledOptions.forEach(option => {
                    const button = document.createElement('button');
                    button.innerHTML = option.text;
                    button.dataset.correct = option.isCorrect;
                    button.classList.add('w-full', 'text-left', 'p-4', 'border-2', 'border-slate-300', 'rounded-lg', 'hover:bg-slate-100', 'hover:border-blue-500', 'transition-colors', 'duration-200');
                    button.addEventListener('click', () => selectAnswer(button, option.isCorrect));
                    answerArea.appendChild(button);
                });
            }
            onKatexLoad();
        }

        function selectAnswer(button, isCorrect) {
            disableAnswers();
            if (isCorrect) {
                score++;
                button.classList.add('correct-answer');
                resultText.textContent = '–ü—Ä–∞–≤–∏–ª—å–Ω–æ!';
                resultText.classList.add('bg-green-100', 'text-green-700');
            } else {
                button.classList.add('incorrect-answer');
                resultText.textContent = '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!';
                resultText.classList.add('bg-red-100', 'text-red-700');
                const correctButton = Array.from(answerArea.children).find(btn => btn.dataset.correct === 'true');
                if (correctButton) {
                    correctButton.classList.add('correct-answer');
                }
            }
            saveState(); // Save state after answering
            nextBtn.classList.remove('hidden');
            nextBtn.focus();
        }

        function checkFreeResponseAnswer() {
            const input = document.getElementById('free-response-input');
            const userAnswer = input.value.trim().replace(',', '.');
            if (userAnswer === '') return;
            disableAnswers();

            const currentQuestion = quizData[currentQuestionIndex];
            if (currentQuestion.correctAnswers.includes(userAnswer)) {
                score++;
                input.classList.add('correct-input');
                resultText.textContent = '–ü—Ä–∞–≤–∏–ª—å–Ω–æ!';
                resultText.classList.add('bg-green-100', 'text-green-700');
            } else {
                input.classList.add('incorrect-input');
                resultText.innerHTML = `–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ! –í–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç: <strong>${currentQuestion.correctAnswers[0]}</strong>`;
                resultText.classList.add('bg-red-100', 'text-red-700');
            }
            saveState(); // Save state after answering
            onKatexLoad();
            nextBtn.classList.remove('hidden');
            nextBtn.focus();
        }
        
        function disableAnswers() {
            Array.from(answerArea.children).forEach(child => {
                if (child.tagName === 'BUTTON') {
                    child.disabled = true;
                    child.classList.add('opacity-70', 'cursor-not-allowed');
                } else {
                    const input = child.querySelector('input');
                    const btn = child.querySelector('button');
                    if(input) input.disabled = true;
                    if(btn) {
                       btn.disabled = true;
                       btn.classList.add('opacity-70', 'cursor-not-allowed');
                    }
                }
            });

            const currentQuestion = quizData[currentQuestionIndex];
            if (currentQuestion.hint) {
                hintTextEl.innerHTML = currentQuestion.hint;
                hintBox.classList.remove('hidden');
                onKatexLoad();
            }
        }
        
        async function sendResultsToGoogleSheet(resultData) {
            if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === '') {
                console.warn('Google Script URL is not specified. Results will not be saved.');
                savingStatus.textContent = 'URL –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.';
                savingStatus.classList.add('text-yellow-600');
                return;
            }
            
            savingStatus.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...';
            savingStatus.className = 'text-sm text-slate-500 mb-4';

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Important for sending to Google Scripts from a browser
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(resultData)
                });
                console.log('Results sent successfully (assumed due to no-cors mode)');
                savingStatus.textContent = '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ!';
                savingStatus.classList.add('text-green-600');

            } catch (error) {
                 console.error('Network error while sending results:', error);
                 savingStatus.textContent = '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–æ—à–∏–±–∫–∞ —Å–µ—Ç–∏).';
                 savingStatus.classList.add('text-red-600');
            }
        }

        function showResults(isTimeUp = false) {
            clearInterval(timerInterval);
            clearState(); // Clear saved state once quiz is finished
            
            quizContainer.classList.add('hidden');
            resultsContainer.classList.remove('hidden');
            
            userNameResult.textContent = `–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è: ${firstName} ${lastName}`;
            scoreText.textContent = `${score}/${quizData.length}`;

            const percentage = Math.round((score / quizData.length) * 100);
            scorePercentageEl.textContent = `${percentage}%`;
            
            // Animate circle
            setTimeout(() => {
                 resultCircle.style.strokeDasharray = `${percentage}, 100`;
            }, 100);


            let grade = 2;
            let gradeColor = 'text-red-500';

            if(isTimeUp) {
                resultMessage.textContent = "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—Ä–µ–º—è –≤—ã—à–ª–æ.";
            } else {
                if (percentage >= 90) { // 18-20 correct
                    grade = 5;
                    gradeColor = 'text-green-500';
                    resultMessage.textContent = "–û—Ç–ª–∏—á–Ω–æ! –í—ã –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ —Ä–∞–∑–±–∏—Ä–∞–µ—Ç–µ—Å—å –≤ —Ç–µ–º–µ!";
                } else if (percentage >= 75) { // 15-17 correct
                    grade = 4;
                    gradeColor = 'text-blue-600';
                    resultMessage.textContent = "–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –í—ã —Ö–æ—Ä–æ—à–æ –∑–Ω–∞–µ—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª.";
                } else if (percentage >= 50) { // 10-14 correct
                    grade = 3;
                    gradeColor = 'text-yellow-500';
                     resultMessage.textContent = "–ù–µ–ø–ª–æ—Ö–æ, –Ω–æ —Å—Ç–æ–∏—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –º–æ–º–µ–Ω—Ç—ã.";
                } else {
                     resultMessage.textContent = "–ù—É–∂–Ω–æ –µ—â–µ –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–¥ —ç—Ç–æ–π —Ç–µ–º–æ–π.";
                }
            }
            
            gradeText.textContent = grade;
            gradeText.className = `text-2xl sm:text-3xl font-bold ${gradeColor}`;
            resultCircle.className = `stroke-current ${gradeColor} transition-all duration-1000 ease-out`;
            
            const resultData = {
                firstName: firstName,
                lastName: lastName,
                score: score,
                totalQuestions: quizData.length,
                percentage: percentage,
                grade: grade
            };

            sendResultsToGoogleSheet(resultData);
        }

        // --- Event Listeners ---
        startBtn.addEventListener('click', () => {
            firstName = firstNameInput.value.trim();
            lastName = lastNameInput.value.trim();
            if (firstName === '' || lastName === '') {
                nameError.classList.remove('hidden');
            } else {
                nameError.classList.add('hidden');
                
                // Reset state for new quiz
                score = 0;
                currentQuestionIndex = 0;
                timeLeft = totalTime;
                shuffleArray(quizData);
                
                startContainer.classList.add('hidden');
                quizContainer.classList.remove('hidden');
                
                startTimer();
                startQuiz();
                saveState(); // Initial save
            }
        });

        nextBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizData.length) {
                saveState(); // Save before loading next question
                loadQuestion();
            } else {
                showResults();
            }
        });

        restartBtn.addEventListener('click', () => {
            clearState(); // Ensure state is cleared before restarting
            resultsContainer.classList.add('hidden');
            startContainer.classList.remove('hidden');
            firstNameInput.value = '';
            lastNameInput.value = '';
            timerEl.classList.remove('text-red-500', 'font-bold');
        });
        
        // Save state automatically when the user is about to leave the page
        window.addEventListener('beforeunload', saveState);
        
        // --- Initial Load ---
        resumeQuiz(); // Check for a saved state when the page loads
        onKatexLoad(); // Initial render of any math formulas
    });
</script>

</body>
</html>

